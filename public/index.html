<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>IMPRESSORAS SEDE</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4280/4280643.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container" tabindex="0">
    <img src="https://i.imgur.com/7EzceCl.jpeg" alt="Logo" class="logo" />
    <h2>IMPRESSORAS SEDE</h2>
    <label for="codigo">Digite o c√≥digo, IP ou setor da impressora:</label>
    <input type="text" id="codigo" placeholder="Ex: H-773, 172.16.30.15, PROVIMENTO" autocomplete="off" />
    <button onclick="consultar()">Consultar</button>
    <div id="resultado"></div>
  </div>
  <!-- Bot√£o Admin -->
  <button
    id="adminBtn"
    style="position: fixed; bottom: 20px; right: 20px; z-index: 999; padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;"
  >
    Modo Admin
  </button>

  <div
    id="adminModal"
    style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000;"
  >
    <div
      style="background: white; color: var(--verde-escuro); border-radius: 12px; max-width: 480px; width: 90%; padding: 30px 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.25); position: relative;"
    >
      <h2 style="text-align:center; margin-bottom: 24px;">Modo Admin</h2>

      <button onclick="showAddPrinter()" style="width: 100%; margin-bottom: 15px; padding: 12px; font-weight: 700; font-size: 1.1rem; border-radius: 8px; border: none; background: var(--verde); color: white; cursor: pointer;">
        Adicionar Impressora
      </button>

      <button onclick="showEditPrinter()" style="width: 100%; margin-bottom: 15px; padding: 12px; font-weight: 700; font-size: 1.1rem; border-radius: 8px; border: none; background: var(--laranja); color: white; cursor: pointer;">
        Editar Impressora
      </button>

      <button onclick="showDeletePrinter()" style="width: 100%; margin-bottom: 15px; padding: 12px; font-weight: 700; font-size: 1.1rem; border-radius: 8px; border: none; background: #c0392b; color: white; cursor: pointer;">
        Apagar Impressora
      </button>

      <!-- ADI√á√ÉO: Bot√£o N√≠veis de Toner -->
      <button onclick="showTonerLevels()" style="width: 100%; margin-bottom: 15px; padding: 12px; font-weight: 700; font-size: 1.1rem; border-radius: 8px; border: none; background: var(--verde-citrico); color: var(--verde-escuro); cursor: pointer;">
        N√≠veis de Toner
      </button>

      <button onclick="closeAdminModal()" style="width: 100%; padding: 12px; font-weight: 700; font-size: 1.1rem; border-radius: 8px; border: none; background: #555; color: white; cursor: pointer;">
        Fechar
      </button>

      <div id="adminContent" style="margin-top: 20px; text-align: left;"></div>
    </div>
  </div>
<script>
    
  window.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const codigo = urlParams.get("codigo");
    if (codigo) {
      document.getElementById("codigo").value = codigo;
      consultar(); // dispara a busca automaticamente
    }
  });

    async function consultar() {
      const input = document.getElementById("codigo").value.trim().toUpperCase();
      const resultado = document.getElementById("resultado");

      if (!input) {
        resultado.innerHTML = "<p class='erro'>Por favor, digite um valor para buscar.</p>";
        resultado.classList.add("visivel");
        return;
      }
      
      const res = await fetch('/api/impressoras');
      const impressoras = await res.json();

      const resultados = impressoras.filter(p =>
        p.id.includes(input) || p.setor.includes(input) || p.ip.includes(input)
      );

      if (resultados.length > 0) {
        resultado.innerHTML = resultados.map(p => {
          const ipHTML = p.ip.includes(".") && p.ip !== "SEM IP"
            ? `<a href="http://${p.ip}" target="_blank">${p.ip}</a>` : p.ip;
          return `<p><strong>üìù C√≥digo:</strong> ${p.id}</p>
                  <p><strong>üè¨ Setor:</strong> ${p.setor}</p>
                  <p><strong>üìç IP:</strong> ${ipHTML}</p>
                  <p><strong>üñ®Ô∏è Modelo Toner:</strong> ${p.modelo}</p>
                  <hr />`;
        }).join("");
      } else {
        resultado.innerHTML = `<p class="erro">Nenhum resultado encontrado para: ${input}</p>`;
      }

      resultado.classList.remove("visivel");
      void resultado.offsetWidth;
      resultado.classList.add("visivel");
    }

    // Fun√ß√µes do modo Admin adaptadas para API
    async function addPrinter() {
      const nova = {
        id: document.getElementById("addCodigo").value.trim().toUpperCase(),
        setor: document.getElementById("addSetor").value.trim().toUpperCase(),
        ip: document.getElementById("addIP").value.trim(),
        modelo: document.getElementById("addModelo").value.trim()
      };

      if (!nova.id || !nova.setor || !nova.ip || !nova.modelo) {
        alert("Preencha todos os campos.");
        return;
      }

      await fetch('/api/impressoras', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(nova)
      });

      alert("Impressora adicionada com sucesso!");
      closeAdminModal();
    }

    async function deletePrinter() {
      const codigoDelete = document.getElementById("deleteCodigo").value.trim().toUpperCase();

      if (!confirm(`Tem certeza que deseja apagar a impressora ${codigoDelete}?`)) return;

      await fetch(`/api/impressoras/${codigoDelete}`, { method: 'DELETE' });

      alert("Impressora apagada com sucesso!");
      closeAdminModal();
    }

    async function loadPrinterForEdit() {
      const codigoBusca = document.getElementById("editCodigo").value.trim().toUpperCase();
      const editForm = document.getElementById("editForm");

      const res = await fetch('/api/impressoras');
      const impressoras = await res.json();
      const impressora = impressoras.find(p => p.id === codigoBusca);

      if (!impressora) {
        editForm.innerHTML = `<p class="erro">Impressora com c√≥digo ${codigoBusca} n√£o encontrada.</p>`;
        return;
      }

      editForm.innerHTML = `
        <label for="editSetor">Setor:</label>
        <input type="text" id="editSetor" value="${impressora.setor}" />
        <label for="editIP">IP:</label>
        <input type="text" id="editIP" value="${impressora.ip}" />
        <label for="editModelo">Modelo Toner:</label>
        <input type="text" id="editModelo" value="${impressora.modelo}" />
        <button onclick="saveEditedPrinter('${impressora.id}')">Salvar Altera√ß√µes</button>
      `;
    }

    async function saveEditedPrinter(id) {
      const atualizada = {
        id,
        setor: document.getElementById("editSetor").value.trim().toUpperCase(),
        ip: document.getElementById("editIP").value.trim(),
        modelo: document.getElementById("editModelo").value.trim()
      };

      await fetch(`/api/impressoras/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(atualizada)
      });

      alert("Impressora atualizada com sucesso!");
      closeAdminModal();
    }

    document.getElementById("adminBtn").addEventListener("click", () => {
      document.getElementById("adminModal").style.display = "flex";
      document.getElementById("adminContent").innerHTML = "";
    });

    function closeAdminModal() {
      document.getElementById("adminModal").style.display = "none";
    }

    function showAddPrinter() {
      const content = document.getElementById("adminContent");
      content.innerHTML = `
        <h3>Adicionar Nova Impressora</h3>
        <label for="addCodigo">C√≥digo:</label>
        <input type="text" id="addCodigo" placeholder="Ex: H-999" />
        <label for="addSetor">Setor:</label>
        <input type="text" id="addSetor" placeholder="Ex: FINANCEIRO" />
        <label for="addIP">IP:</label>
        <input type="text" id="addIP" placeholder="Ex: 172.16.30.99" />
        <label for="addModelo">Modelo Toner:</label>
        <input type="text" id="addModelo" placeholder="Ex: 4070" />
        <button onclick="addPrinter()">Adicionar</button>
      `;
    }

    function showEditPrinter() {
      const content = document.getElementById("adminContent");
      content.innerHTML = `
        <h3>Editar Impressora</h3>
        <label for="editCodigo">Digite o c√≥digo da impressora para editar:</label>
        <input type="text" id="editCodigo" placeholder="Ex: H-785" />
        <button onclick="loadPrinterForEdit()">Buscar</button>
        <div id="editForm" style="margin-top: 15px;"></div>
      `;
    }

    function showDeletePrinter() {
      const content = document.getElementById("adminContent");
      content.innerHTML = `
        <h3>Apagar Impressora</h3>
        <label for="deleteCodigo">Digite o c√≥digo da impressora para apagar:</label>
        <input type="text" id="deleteCodigo" placeholder="Ex: H-785" />
        <button onclick="deletePrinter()">Apagar</button>
      `;
    }

    /* ======================= ADI√á√ïES: m√≥dulo N√≠veis de Toner ======================= */
    function showTonerLevels() {
      const content = document.getElementById("adminContent");
      content.innerHTML = `
        <h3>N√≠veis de Toner</h3>
        <p>Buscando informa√ß√µes nas p√°ginas das impressoras (pode depender de CORS e autentica√ß√£o)...</p>
        <div id="tonerWrapper" style="overflow:auto; max-height:60vh; border:1px solid #eee; border-radius:8px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">C√≥digo</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Setor</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">IP</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Toners (%)</th>
              </tr>
            </thead>
            <tbody id="tonerBody">
              <tr><td colspan="4" style="padding:10px;">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      `;

      const tbody = () => document.getElementById("tonerBody");

      const tasks = impressoras.map(item => {
        const { id: codigo, setor, ip, modelo } = item;
        const validIP = ip && ip !== "SEM IP" && ip.includes(".");
        if (!validIP) {
          return Promise.resolve(rowHTML(codigo, setor, ip, "Sem IP"));
        }

        return fetch(`http://${ip}`)
          .then(r => r.text())
          .then(html => {
            const percents = extractPercents(html);
            const result = percents.length ? percents.join(", ") : "N√£o encontrado";
            return rowHTML(codigo, setor, `<a href="http://${ip}" target="_blank">${ip}</a>`, result);
          })
          .catch(() => rowHTML(codigo, setor, `<a href="http://${ip}" target="_blank">${ip}</a>`, "Sem acesso (CORS/offline)"));
      });

      Promise.all(tasks).then(rows => {
        tbody().innerHTML = rows.join("");
      });

      function rowHTML(codigo, setor, ipCell, tonerText) {
        return `
          <tr>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${codigo}</td>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${setor}</td>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${ipCell}</td>
            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${tonerText}</td>
          </tr>
        `;
      }

      function extractPercents(html) {
        // captura 0-100% e evita n√∫meros inv√°lidos
        const m = html.match(/\b\d{1,3}%\b/g) || [];
        const uniq = Array.from(new Set(m));
        return uniq.filter(p => {
          const n = parseInt(p, 10);
          return n >= 0 && n <= 100;
        });
      }
    }
    /* ===================== FIM ADI√á√ïES: m√≥dulo N√≠veis de Toner ===================== */
  </script>
</body>
</html>
